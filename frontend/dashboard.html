<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - Sports Numerology API</title>
    <link rel="stylesheet" href="../static/styles.css">
    <link rel="stylesheet" href="../static/utilities.css">
    <link rel="stylesheet" href="../static/app.css">
</head>

<body>
    <header>
        <nav>
            <a href="index.html">üîÆ SPORTOLOGY</a>
            <div>
                <a href="index.html">Home</a>
                <span class="badge" id="user-email"></span>
                <button class="cta-secondary" onclick="logout()">Logout</button>
            </div>
        </nav>
    </header>

    <main class="page shell">
        <section class="shell-header">
            <div>
                <h1>Dashboard</h1>
                <p>Manage your API keys and monitor usage.</p>
            </div>
            <span class="badge">Plan: Free ¬∑ 10/day</span>
        </section>

        <section class="grid-2">
            <article class="card">
                <header>
                    <div class="row">
                        <h2>üìä Usage</h2>
                    </div>
                </header>

                <section class="stats">
                    <figure class="stat">
                        <figcaption>Today</figcaption>
                        <data id="today-requests">0</data>
                    </figure>
                    <figure class="stat">
                        <figcaption>This Month</figcaption>
                        <data id="month-requests">0</data>
                    </figure>
                    <figure class="stat">
                        <figcaption>Total</figcaption>
                        <data id="total-requests">0</data>
                    </figure>
                </section>

                <div class="progress-wrap">
                    <div class="row" style="justify-content: space-between;">
                        <span class="muted">Daily limit</span>
                        <span class="muted"><span id="usage-now">0</span> / 10</span>
                    </div>
                    <progress id="usage-bar" value="0" max="10"></progress>
                </div>
            </article>

            <article class="card">
                <header>
                    <div class="row">
                        <h2>üîê API Keys</h2>
                        <button class="cta-primary" onclick="showCreateKeyModal()">+ New key</button>
                    </div>
                </header>

                <p class="muted">Use these keys to authenticate requests. Keep them secret.</p>

                <section id="api-keys-list" class="keylist" style="margin-top: 12px;">
                    <!-- keys -->
                </section>
            </article>
        </section>

        <section class="card">
            <header>
                <div class="row">
                    <h2>üìö Resources</h2>
                </div>
            </header>

            <section class="resource-grid">
                <a class="resource" href="/docs">
                    <h3>üìñ API Documentation</h3>
                    <p>Endpoints & examples</p>
                </a>
                <a class="resource" href="#">
                    <h3>üíª Code Examples</h3>
                    <p>Python, JavaScript, and more</p>
                </a>
                <a class="resource" href="index.html#demo">
                    <h3>üéæ Try Demo</h3>
                    <p>Test the API without code</p>
                </a>
            </section>
        </section>
    </main>

    <dialog id="create-key-modal">
        <article class="dialog-card">
            <header>
                <h2>Generate New API Key</h2>
            </header>
            <div class="dialog-body">
                <div class="form-row">
                    <label for="key-name">Key Name (optional)</label>
                    <input type="text" id="key-name" placeholder="My App" />
                </div>
            </div>
            <footer>
                <button class="cta-secondary" onclick="closeCreateKeyModal()">Cancel</button>
                <button class="cta-primary" onclick="generateApiKey()">Generate</button>
            </footer>
        </article>
    </dialog>

    <dialog id="show-key-modal">
        <article class="dialog-card">
            <header>
                <h2>Your New API Key</h2>
            </header>
            <div class="dialog-body">
                <p class="muted">Copy it now ‚Äî you won‚Äôt be able to see it again.</p>
                <code id="new-api-key" class="kcode"></code>
            </div>
            <footer>
                <button class="cta-secondary" onclick="copyApiKey()">Copy</button>
                <button class="cta-primary" onclick="closeShowKeyModal()">Done</button>
            </footer>
        </article>
    </dialog>

    <script>
        const token = localStorage.getItem('token');
        if (!token) window.location.href = 'login.html';

        const user = JSON.parse(localStorage.getItem('user') || '{}');
        if (user.email) document.getElementById('user-email').textContent = user.email;

        async function loadApiKeys() {
            try {
                const response = await fetch('/api-keys', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) throw new Error('Failed to load keys');

                const apiKeys = await response.json();
                renderApiKeys(apiKeys);
                updateUsageStats();
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function renderApiKeys(apiKeys) {
            const container = document.getElementById('api-keys-list');

            if (!apiKeys || apiKeys.length === 0) {
                container.innerHTML = '<p class="muted">No API keys yet. Generate one to get started.</p>';
                return;
            }

            container.innerHTML = apiKeys.map(key => `
        <div class="keyrow">
          <div class="keyrow-top">
            <div>
              <div class="keyname">${escapeHtml(key.name || 'Unnamed Key')}</div>
              <div class="kmeta">Created: ${new Date(key.created_at).toLocaleDateString()}</div>
            </div>
            <button class="cta-secondary" onclick="revokeKey('${key.id}')">Revoke</button>
          </div>
          <code class="kcode">${escapeHtml(key.api_key)}</code>
        </div>
      `).join('');
        }

        async function updateUsageStats() {
            try {
                const response = await fetch('/api/v1/usage-stats', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) throw new Error('Failed to load stats');
                
                const data = await response.json();
                
                document.getElementById('today-requests').textContent = data.today;
                document.getElementById('month-requests').textContent = data.this_month;
                document.getElementById('total-requests').textContent = data.total;
                document.getElementById('usage-now').textContent = data.today;
                document.getElementById('usage-bar').value = Math.min(data.today, data.limit);
                document.getElementById('usage-bar').max = data.limit;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        function showCreateKeyModal() {
            document.getElementById('create-key-modal').showModal();
        }
        function closeCreateKeyModal() {
            document.getElementById('create-key-modal').close();
        }

        async function generateApiKey() {
            const name = document.getElementById('key-name').value;

            try {
                const response = await fetch('/api-keys', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name: name || 'My App' })
                });

                if (!response.ok) throw new Error('Failed to create key');

                const data = await response.json();

                closeCreateKeyModal();
                document.getElementById('new-api-key').textContent = data.api_key;
                document.getElementById('show-key-modal').showModal();

                loadApiKeys();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        function closeShowKeyModal() {
            document.getElementById('show-key-modal').close();
        }

        function copyApiKey() {
            const key = document.getElementById('new-api-key').textContent;
            navigator.clipboard.writeText(key).then(() => alert('Copied to clipboard!'));
        }

        async function revokeKey(keyId) {
            if (!confirm('Are you sure? This action cannot be undone.')) return;

            try {
                const response = await fetch(`/api-keys/${keyId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) throw new Error('Failed to revoke key');
                loadApiKeys();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'index.html';
        }

        function escapeHtml(str) {
            return String(str).replace(/[&<>"']/g, m => ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
            }[m]));
        }

        loadApiKeys();
    </script>
</body>

</html>